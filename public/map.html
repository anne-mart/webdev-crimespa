<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>St. Paul Crime Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin:0; padding:20px; font-family:Arial,sans-serif; background:#f8f9fa; }
        #map { height:680px; width:100%; border:3px solid #2c3e50; border-radius:10px; }
        h1 { text-align:center; color:#2c3e50; margin-bottom:10px; }
        h2 { margin-top:30px; color:#34495e; }
        table { width:100%; border-collapse:collapse; background:white; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
        th, td { padding:10px; border:1px solid #ddd; text-align:left; }
        th { background:#2c3e50; color:white; }
        #count { font-weight:bold; color:#d31a3f; }

        #legend {
            margin: 15px 0;
            padding: 10px 15px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: fit-content;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .legend-item {
            display:flex;
            align-items:center;
            margin-bottom:6px;
            font-size:14px;
        }
        .legend-color {
            width:18px;
            height:18px;
            border-radius:4px;
            margin-right:8px;
            border:1px solid #888;
        }
    </style>
</head>
<body>

    <nav style="margin-bottom: 15px; text-align: center;">
        <a href="/about.html" 
            style="font-size: 18px; color:#2c3e50; text-decoration:none; font-weight:bold;">
            About the Project
        </a>
    </nav>

<h1>St. Paul Crime Map</h1>
<div id="map"></div>
<div id="legend">
    <div class="legend-item"><div class="legend-color" style="background:#ff000022;"></div>Violent Crimes</div>
    <div class="legend-item"><div class="legend-color" style="background:#0000ff22;"></div>Property Crimes</div>
    <div class="legend-item"><div class="legend-color" style="background:#00aa0022;"></div>Other Crimes</div>
</div>

<h2>Crimes in Visible Neighborhoods <span id="count">(loading...)</span></h2>

<h2>Add New Crime Incident</h2>

<form id="incident-form" style="
    background:white; padding:15px; border:1px solid #ccc;
    border-radius:8px; margin-bottom:20px; max-width:600px;">
    
    <label>Case Number (required)<br>
        <input id="f-case" required>
    </label><br><br>

    <label>Date (YYYY-MM-DD) (required)<br>
        <input id="f-date" type="date" required>
    </label><br><br>

    <label>Time (HH:MM) (required)<br>
        <input id="f-time" type="time" required>
    </label><br><br>

    <label>Crime Code (required)<br>
        <input id="f-code" type="number" required>
    </label><br><br>

    <label>Incident Type (required)<br>
        <input id="f-incident" required>
    </label><br><br>

    <label>Police Grid (required)<br>
        <input id="f-grid" type="number" required>
    </label><br><br>

    <label>Neighborhood # (required)<br>
        <input id="f-hood" type="number" required>
    </label><br><br>

    <label>Block (required)<br>
        <input id="f-block" required>
    </label><br><br>

    <button type="submit" style="padding:8px 18px;">Submit</button>
</form>

<div id="form-message" style="font-weight:bold; margin-bottom:20px;"></div>

<table>
    <thead>
        <tr>
            <th>Case #</th>
            <th>Date</th>
            <th>Time</th>
            <th>Code</th>
            <th>Type</th>
            <th>Neighborhood</th>
            <th>Block</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody id="crime-tbody"></tbody>
</table>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let selectedMarker = null;
    const map = L.map('map').setView([44.9537, -93.0900], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let allCrimes = [];
    let something = null;
    let markers = L.layerGroup().addTo(map);

    async function start() {
        const geoRes = await fetch('data/StPaulDistrictCouncil.geojson');
        const geojson = await geoRes.json();
        something = L.geoJSON(geojson, {
            style: { color: "#3498db", weight: 2, fillOpacity: 0.1 },
            onEachFeature: (feature, layer) => {
                const p = feature.properties;
                const number = Number(p.district);
                const name = p.name1 || "Unknown";

                layer._hoodNumber = number;
                layer.bindTooltip(name, { permanent: false, sticky: true, direction: "center" });
            }
        }).addTo(map);

        map.fitBounds(something.getBounds());

        // getting crimes...
        const crimeRes = await fetch('/incidents-expanded');
        allCrimes = await crimeRes.json();
        document.getElementById('count').textContent = '(zoom in to see crimes)';
        update();
    }
    function categorizeCrime(type) {
        const t = type.toUpperCase();

        // Violent crimes ... light red
        if (t.includes("HOMICIDE") ||
            t.includes("MURDER") ||
            t.includes("ROBBERY") ||
            t.includes("ASSAULT") ||
            t.includes("SEX") ||
            t.includes("RAPE") ||
            t.includes("KIDNAP")) {
            return "#ff000022";
        }

        // Property crimes... light blue
        if (t.includes("BURGLARY") ||
            t.includes("THEFT") ||
            t.includes("LARCENY") ||
            t.includes("VANDALISM") ||
            t.includes("DAMAGE") ||
            t.includes("ARSON") ||
            t.includes("FRAUD") ||
            t.includes("FORGERY")) {
            return "#0000ff22";
        }

        // Other... light green
        return "#00aa0022";
    }
    function getVisibleHoods() {
        if (!something) return [];
        const bounds = map.getBounds();
        const set = new Set();
        something.eachLayer(layer => {
            if (layer._hoodNumber && bounds.intersects(layer.getBounds())) {
                set.add(layer._hoodNumber);
            }
        });
        return Array.from(set);
    }
    function update() {
        const visible = getVisibleHoods();
        const crimes = allCrimes
            .filter(c => visible.includes(Number(c.neighborhood_number)))
            .sort((a,b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
        const tbody = document.getElementById('crime-tbody');
        tbody.innerHTML = '';
        crimes.slice(0, 200).forEach(c => {
            const color = categorizeCrime(c.incident_type);
            tbody.innerHTML += `
                <tr style="background-color:${color}; cursor:pointer;"
                    onclick="selectCrime(${c.case_number}, '${c.block}', '${c.date}', '${c.time}', '${c.incident_type}')">
                    <td>${c.case_number}</td>
                    <td>${c.date}</td>
                    <td>${c.time}</td>
                    <td>${c.code}</td>
                    <td>${c.incident_type}</td>
                    <td>${c.neighborhood_name}</td>
                    <td>${c.block}</td>
                    <td>
                        <button 
                            onclick="event.stopPropagation(); deleteIncident('${c.case_number}')"
                            style="background:#c0392b; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
                            Delete
                        </button>
                    </td>
                </tr>`;
        });
        document.getElementById('count').textContent = `(${crimes.length} visible)`;
        markers.clearLayers();
        const counts = {};
        crimes.forEach(c => {
            const n = Number(c.neighborhood_number);
            counts[n] = (counts[n] || 0) + 1;
        });

        something.eachLayer(layer => {
            const n = layer._hoodNumber;
            if (n && counts[n]) {
                const center = layer.getBounds().getCenter();
                const sampleCrime = crimes.find(c => Number(c.neighborhood_number) === n);
                const color = categorizeCrime(sampleCrime.incident_type).replace("22", "ff");
                L.circleMarker(center, {
                    radius: Math.min(30, 8 + counts[n]),
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                })
                .bindPopup(`<b>${layer.getTooltip().getContent()}</b><br>${counts[n]} crimes`)
                .addTo(markers);
            }
        });
    }

    start();
    map.on('moveend', update);

    // FORM HANDLING — PUT /new-incident
document.getElementById("incident-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const msg = document.getElementById("form-message");
    msg.textContent = "";

    // Collect form fields
    const data = {
        case_number: document.getElementById("f-case").value.trim(),
        date: document.getElementById("f-date").value,
        time: document.getElementById("f-time").value,
        code: document.getElementById("f-code").value,
        incident: document.getElementById("f-incident").value.trim(),
        police_grid: document.getElementById("f-grid").value,
        neighborhood_number: document.getElementById("f-hood").value,
        block: document.getElementById("f-block").value.trim()
    };

    // Validate (simple)
    for (let key in data) {
        if (!data[key]) {
            msg.style.color = "red";
            msg.textContent = `Error: Missing required field "${key}"`;
            return;
        }
    }

    // PUT request
    try {
        const res = await fetch('/new-incident', {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            const err = await res.json();
            msg.style.color = "red";
            msg.textContent = "Upload failed: " + err.error;
            return;
        }

        msg.style.color = "green";
        msg.textContent = "Incident successfully added!";

        // Refresh data on map + table
        const crimeRes = await fetch('/incidents-expanded');
        allCrimes = await crimeRes.json();
        update();

        e.target.reset();

    } catch (err) {
        msg.style.color = "red";
        msg.textContent = "Network error: " + err;
    }
});

async function deleteIncident(caseNumber) {
    if (!confirm(`Delete incident ${caseNumber}?`)) return;

    try {
        const response = await fetch("/remove-incident", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ case_number: caseNumber })
        });

        const text = await response.text();

        if (text === "success") {
            alert("Incident deleted!");

            // Refresh list
            const crimeRes = await fetch('/incidents-expanded');
            allCrimes = await crimeRes.json();
            update();
        } else {
            alert("Delete failed: " + text);
        }
    } catch (err) {
        alert("Network error: " + err);
    }
}
async function selectCrime(caseNumber, block, date, time, incident) {
    // Remove old marker if it exists
    if (selectedMarker) {
        map.removeLayer(selectedMarker);
        selectedMarker = null;
    }

    // Convert "98X UNIVERSITY AV W" → "980 UNIVERSITY AV W"
    const cleanedAddress = cleanAddress(block);

    // Geocode the address (using Nominatim)
    const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanedAddress + ", St Paul MN")}`);
    const results = await geo.json();

    if (results.length === 0) {
        alert("Could not locate address on map: " + cleanedAddress);
        return;
    }

    const { lat, lon } = results[0];

    // Custom marker icon (blue)
    const icon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    selectedMarker = L.marker([lat, lon], { icon }).addTo(map);

    selectedMarker.bindPopup(`
        <b>${incident}</b><br>
        Date: ${date}<br>
        Time: ${time}<br>
        Location: ${cleanedAddress}<br><br>
        <button onclick="deleteIncident('${caseNumber}')"
                style="background:#c0392b; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
            Delete Incident
        </button>
    `).openPopup();

    map.setView([lat, lon], 16);
}

function cleanAddress(raw) {
    let address = raw.trim();
    if (/ AND /i.test(address) || / & /i.test(address)) {
        let sep = / AND /i.test(address) ? / AND /i : / & /i;
        let [street1, street2] = address.split(sep).map(s => s.trim());
        if (!/\b(ST|AVE|AV|RD|DR|BLVD|LN|PKWY|PL|CT|WAY)\b/i.test(street2)) {
            street2 += " AVE";
        }
        address = `${street1} & ${street2}`;
    }
    let parts = address.split(" ");
    if (parts.length > 0) {
        let num = parts[0];
        if (/^\d+X$/.test(num)) {
            num = num.replace("X", "0");
        } else if (/^\d+X+$/.test(num)) {
            num = num.replace(/X+/g, match => "0".repeat(match.length));
        }
        parts[0] = num;
    }
    const dirMap = { N:"NORTH", S:"SOUTH", E:"EAST", W:"WEST" };
    parts = parts.map(tok => dirMap[tok.toUpperCase()] || tok);
    parts = parts.map(tok => {
        if (/^(ST|MT|FT)[A-Z]{2,}/.test(tok)) {
            return tok.slice(0, tok.match(/^(ST|MT|FT)/)[0].length) + " " + tok.slice(tok.match(/^(ST|MT|FT)/)[0].length);
        }
        return tok;
    });

    return parts.join(" ");
}

</script>

</body>
</html>